generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN       // Platform Admin
  TENANT_ADMIN // Tenant Owner
  MANAGER     // Branch Manager
  FINANCE
  GARAGE_STAFF
  AUDIT_OFFICER
  WORKER
}

model Tenant {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  slug        String   @unique
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  users       User[]
  branches    Branch[]
  auditLogs   AuditLog[]

  @@map("tenants")
}

model Branch {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  tenantId    String   @db.Uuid
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  users       User[]
  auditLogs   AuditLog[]

  @@map("branches")
}

model User {
  id                 String         @id @default(uuid())
  email              String         @unique
  password           String
  fullName           String?
  role               Role           @default(WORKER) // Kept WORKER as USER is not in enum
  hashedRefreshToken String?
  
  // MFA Fields
  mfaSecret          String?
  isMfaEnabled       Boolean        @default(false)

  tenantId    String
  branchId    String? // Nullable for Tenant Admins who manage all branches

  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt

  tenant             Tenant         @relation(fields: [tenantId], references: [id])
  branch             Branch?        @relation(fields: [branchId], references: [id])
  securityLogs       SecurityLog[]
  accessPolicies     AccessPolicy[]
  auditLogs   AuditLog[]

  @@map("users")
}

model SecurityLog {
  id        String   @id @default(uuid())
  userId    String
  action    String   // LOGIN, LOGOUT, VIEW, CREATE, DELETE
  ipAddress String
  userAgent String?
  device    String?  // Mobile, Desktop, etc.
  location  String?  // Country, City (GeoIP)
  details   String?  // JSON details
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id])
}

model AccessPolicy {
  id          String   @id @default(uuid())
  userId      String
  name        String   // "Standard Office Hours"
  
  // Restrictions
  allowedDays Int[]    // 0=Sunday, 1=Monday... 6=Saturday
  allowedStartHour Int? // e.g., 9 (09:00)
  allowedEndHour   Int? // e.g., 18 (18:00)
  allowedIps       String[] // List of CIDR or IPs
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id])
}

model AuditLog {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  action      String
  module      String
  details     Json?
  ipAddress   String?
  
  userId      String   @db.Uuid
  tenantId    String   @db.Uuid
  branchId    String?  @db.Uuid

  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id])
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  branch      Branch?  @relation(fields: [branchId], references: [id])

  @@map("audit_logs")
}
